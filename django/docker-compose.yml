version: "3"

services:
  django:
    build:
      context: ./django/
      dockerfile: Dockerfile
      args:
        USER: ${USER}
        PASSWD: ${PASSWD}
        USER_ID: ${USER_ID}
        GROUP_ID: ${GROUP_ID}
        APP_PATH: ${HOME}/${APP_PATH}
    depends_on:
      - postgres
    volumes:
      - staticdata:/opt/static
      - ~/work/django:${HOME}/${APP_PATH}
    environment:
      PYTHONPATH: ${HOME}/${APP_PATH}
    expose:
      - ${DJANGO_PORT}
    entrypoint: bash -c "python manage.py collectstatic --noinput && python manage.py migrate && gunicorn project_x.wsgi -b 0.0.0.0:${DJANGO_PORT}"
    restart: always

  nginx:
    image: nginx
    depends_on:
      - django
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - staticdata:/opt/static
    restart: always

  postgres:
    image: postgres
    ports:
      - "5432:5432"
    volumes:
      - dbdata:/var/lib/postgresql/data
    environment:
      POSTGRES_PASSWORD: ${PASSWD}

volumes:
  dbdata:
  staticdata:
